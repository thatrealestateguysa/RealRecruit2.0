<!DOCTYPE html>

// Agency
const tdAgency = document.createElement('td'); tdAgency.textContent = r.agency || ''; tr.appendChild(tdAgency);

// Suburb
const tdSuburb = document.createElement('td'); tdSuburb.textContent = r.suburb || ''; tr.appendChild(tdSuburb);

tb.appendChild(tr);
}
$('#checkAll').checked = false;
}

function selectedIndices(){ return $$('#tbody input[type="checkbox"]:checked').map(cb=>parseInt(cb.dataset.idx,10)); }
function lockRow(tr, lock){ tr.style.opacity = lock? .6 : 1; }

async function load(){
$('#tbody').innerHTML = '<tr><td colspan="10">Loadingâ€¦</td></tr>';
try{
const j = await apiGet();
if(j.result!=='success') throw new Error(j.message||'Unknown error');
const data = j.data||[];
if(!data.length){ rows=[]; filtered=[]; renderStatusTabs(); renderTable(); return; }
const dataRows = data.slice(1); // drop header
rows = dataRows.map((r,i)=>buildRowObject(r,i));
populateFilters();
renderStatusTabs();
applyFilters();
adjustTableHeight();
$('#openSheetBtn').href = SHEET_URL_HINT;
} catch(e){ console.error(e); toast('Load failed: ' + e.message, 3200); $('#tbody').innerHTML = '<tr><td colspan="10" class="danger">Failed to load. Check CORS / deployment access.</td></tr>'; }
}

function adjustTableHeight(){
const vh = window.innerHeight || document.documentElement.clientHeight;
const topbar = document.querySelector('.topbar');
const pipeline = document.getElementById('pipelineCard');
const tableWrap = document.getElementById('tableWrap');
if(!tableWrap) return;
const padding = 32; // wrap padding/margins
const topH = (topbar?.offsetHeight||0) + (pipeline?.offsetHeight||0) + padding;
const maxH = Math.max(240, vh - topH - 24);
tableWrap.style.maxHeight = maxH + 'px';
}

// === EVENTS ===
document.addEventListener('DOMContentLoaded', ()=>{
$('#fltStatus').addEventListener('change', ()=>{ selectedStatus = $('#fltStatus').value; localStorage.setItem('fltStatus', selectedStatus); markActiveStatusTabs(); applyFilters(); adjustTableHeight(); });
$('#fltAgency').addEventListener('change', ()=>{ selectedAgency = $('#fltAgency').value; localStorage.setItem('fltAgency', selectedAgency); applyFilters(); adjustTableHeight(); });
$('#resetFilters').addEventListener('click', ()=>{ selectedStatus=''; selectedAgency=''; localStorage.setItem('fltStatus',''); localStorage.setItem('fltAgency',''); $('#fltStatus').value=''; $('#fltAgency').value=''; markActiveStatusTabs(); applyFilters(); adjustTableHeight(); });

$('#checkAll').addEventListener('change', (e)=>{ $$('#tbody input[type="checkbox"]').forEach(cb=>cb.checked=e.target.checked); });
$('#clearChecks').addEventListener('click', ()=>{ $$('#tbody input[type="checkbox"]').forEach(cb=>cb.checked=false); $('#checkAll').checked=false; });
$('#applyBulk').addEventListener('click', async ()=>{
const idxs = selectedIndices(); const st = $('#bulkStatus').value; if(!idxs.length) return toast('Select some rows'); if(!st) return toast('Choose a bulk status');
try{ await apiPost('bulkUpdateStatus', { rowIndices: idxs, newStatus: st }); toast('Bulk update complete'); await load(); adjustTableHeight(); }
catch(e){ console.error(e); toast('Bulk update failed', 3000); }
});

$('#refreshBtn').addEventListener('click', ()=>{ load(); });
$('#prepareBtn').addEventListener('click', async ()=>{ try{ await apiPost('prepareSheet',{}); toast('Prepared'); load(); }catch(e){ toast('Prepare failed'); }});
$('#rerunBtn').addEventListener('click', async ()=>{ try{ const r = await apiPost('rerunAutomations',{}); toast(r.message||'Re-run complete'); load(); }catch(e){ toast('Re-run failed'); }});
$('#fixBtn').addEventListener('click', async ()=>{ try{ const r = await apiPost('fixDataValidation',{}); toast(r.message||'Fixed'); load(); }catch(e){ toast('Fix failed'); }});

window.addEventListener('resize', adjustTableHeight);
load();
adjustTableHeight();
});

// Utilities
$('#refreshBtn').addEventListener('click', load);
$('#prepareBtn').addEventListener('click', async ()=>{ try{ await apiPost('prepareSheet',{}); toast('Prepared'); load(); }catch(e){ toast('Prepare failed'); }});
$('#rerunBtn').addEventListener('click', async ()=>{ try{ const r = await apiPost('rerunAutomations',{}); toast(r.message||'Re-run complete'); load(); }catch(e){ toast('Re-run failed'); }});
$('#fixBtn').addEventListener('click', async ()=>{ try{ const r = await apiPost('fixDataValidation',{}); toast(r.message||'Fixed'); load(); }catch(e){ toast('Fix failed'); }});

load();
});
</script>
</body>
</html>

